<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page trimDirectiveWhitespaces="true" %>

<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"  %>

<% int i = 0 ; %>
<c:set var="pageMaker" value="${dataMap.pageMaker }" />
<head>
<style>
.pds-wrapper{
	margin: 0 auto;
	width:70%;
}
.pds-wrapper h2{
	text-align: center;
}
tr{
	border-color: #ffd900;
}
th:nth-child(n+3), td:nth-child(n+3){
	text-align: center;
}
.page-item.active .page-link {
    z-index: 3;
    color: #fff;
    background-color: #ffc82d;
    border-color: #ffc82d;
}
</style>
</head>
<body style="padding: 40px; background: white;">
	
	<div class="pds-wrapper">
		<h2>쪽지-수신함</h2><hr>
		<button class="btn btn-yellow me-1 mb-1" onclick="deleteSmail()" >삭제</button>
		<div class="input-group mb-3" style="float:right;width: 300px;">
			<input type="text" class="form-control" placeholder="키워드를 입력하세요" name="keyword" value="${pageMaker.cri.keyword }">
			<div class="input-group-text" onclick="palist_go(1);" style="cursor:pointer;"><i class="fa fa-search"></i></div>
		</div><br><br><br>

		<div class="table-responsive">
		  <table class="table">
			<tr>
				<th><input id="all" type="checkbox">
				<label for="all">전체 체크</label></th>
				<th>보낸 사람</th>
				<th>제목</th>
				<th>받은 날짜</th>
				<th>읽음표시</th>
			</tr>
			<c:forEach items="${rmailList }" var="rmail" >
				<% i++; %>
				<tr>
					<td><input id="all<%=i %>" type="checkbox" name="hobby" value="${rmail.rmCode }"></td>
					<td>
						<a href="javascript:OpenWindow('RmailDetail.do?rmCode=${rmail.rmCode }','상세보기',700,600);">
							<span class="col-sm-12 " style="color: black;">${rmail.rmSender }</span>
						</a>
					</td>
					<td><c:out value="${rmail.rmTitle }" /></td>
					<td>${rmail.rmReceivedate }</td>
					<td>
						<c:if test="${rmail.rmRstatus == 0}">
							x(안읽음)
						</c:if>
						<c:if test="${rmail.rmRstatus == 1}">
							O(읽음)
						</c:if>
					</td>
				</tr>
			</c:forEach>
			<% i=0; %>		
		  </table>
		</div>
		<div style="display: flex; justify-content: center;">
			<c:set var="list_url" value="sendmail.do" />
			<div class="pagination">
				<div class="page-item">
				<a class="page-link" href="javascript:palist_go(1,'${list_url }');">
					<i class="fas fa-angle-double-left"></i>
				</a>
				</div>
				<div class="page-item">
					<a class="page-link" href="javascript:palist_go(${pageMaker.prev ? pageMaker.startPage-1 : 1},'${list_url }');">
						<i class="fas fa-angle-left"></i>
					</a>
				</div>
				<c:forEach var="pageNum" begin="${pageMaker.startPage }" end="${pageMaker.endPage }" >
					<div class="page-item ${pageMaker.cri.page == pageNum?'active':''}">
						<a class="page-link" href="javascript:palist_go(${pageNum},'${list_url }');" >${pageNum }</a>
					</div>
				</c:forEach>
				<div class="page-item">
					<a class="page-link" href="javascript:palist_go(${pageMaker.next ? pageMaker.endPage+1 : pageMaker.cri.page},'${list_url }');">
						<i class="fas fa-angle-right" ></i>
					</a>
				</div>
				<div class="page-item">
					<a class="page-link" href="javascript:palist_go(${pageMaker.realEndPage} ,'${list_url }');">
						<i class="fas fa-angle-double-right"></i>
					</a>
				</div>	
			</div>
		</div>
	</div>
		<input id="hobbyList" hidden="" name="hobbyList" value="">
	<form id="jobForm">
		<input type='hidden' name="page" value="${pageMaker.cri.page}" />
		<input type='hidden' name="keyword" value="${pageMaker.cri.keyword }" />
	</form>
	<script>
	window.onload = function() {
		$("#all").click(function(){
			var isChecked = $(this).prop("checked");
			if(isChecked){
				$("[name=hobby]").prop("checked",true);
			}else {
				$("[name=hobby]").prop("checked",false);
			}
		});
		
		$("[name=hobby]").click(function(){
			var num = $("[name=hobby]:checked").not("#allChk").length;
			
			if(num == 5){
				$("#all").prop("checked",true);
			}else {
				$("#all").prop("checked",false);
			}
		});
	}
	
	function palist_go(page, url) {

		if (!url)
			url = "receivemail.do";

		var jobForm = $('#jobForm');
		jobForm.find("[name='page']").val(page);
		jobForm.find("[name='keyword']").val(
				$('div.input-group>input[name="keyword"]').val());

		$('form#jobForm').attr({
			action : url,
			method : 'get'
		}).submit();

	}
	
	
	
	function deleteSmail(){
		var html='';
		$('#hobbyList').val(html);   
		
		var num = $("[name=hobby]:checked").not("#allChk").length;
		
		if(num == 0 ){
			alert("선택한 쪽지가 없습니다.");	
			return;
		}

		
		if(confirm("선택한 쪽지를 삭제하시겠습니까?")){
			
			
		}else{
			return;
		}
		
		if(num == 1){
			 var id= $("[name=hobby]:checked");
			html += ''+id.attr('value')+'';
			$('#hobbyList').val(html);   
		}else {
		
		for(var i = 0; i < num; i++){
			
			 var id= $("[name=hobby]:checked").eq(i);
			 if(i == 0 ){
			 html += ''+id.attr('value')+'';
			 continue;
			 }
			 html += ',';
			 html += ''+id.attr('value')+'';
			 
			  $('#hobbyList').val(html);   
			}
		}
		
		var checked = $('#hobbyList').val();
		
		var data = {
				"checked":checked
		}
		
		$.ajax({
			url : "<%=request.getContextPath() %>/mypage/deleteRmailList",
			type : "post",
			data : JSON.stringify(data),
			contentType:"application/json;charset=utf-8",
			success:function(data){
				
				alert("선택하신 쪽지를 삭제하였습니다\n쪽지는 휴지통에 보관되어 30일 후 영구삭제됩니다.");
				history.go(0);
			},
			
			error:function(error){
				alert("선택하신 쪽지를 삭제하였습니다\n쪽지는 휴지통에 보관되어 30일 후 영구삭제됩니다.");
				history.go(0);		
			}
			
		});
		
		
	}
	</script>
	
</body>


